name: Build and Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend

jobs:
  # Job 1: Build ja testaa frontend
  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker build ja push
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:latest
          labels: ${{ steps.meta.outputs.labels }}

#      - name: Build and push Docker image
#        if: github.event_name != 'pull_request'
#        uses: docker/build-push-action@v5
#        with:
#          context: ./frontend
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}

  # Job 2: Build ja testaa backend
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    services:
      # Test-MySQL container
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Run linter
        working-directory: ./backend
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run tests
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://root:test_password@mysql:3306/test_db
          PYTHONPATH: . # Lisätty tämä rivi koska actioneissa tuli joku error eikä se löytänyt jotain modulea tms. 
        run: pytest --cov=. --cov-report=xml

      # Docker build ja push
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:latest
          labels: ${{ steps.meta.outputs.labels }}

#      - name: Build and push Docker image
#        if: github.event_name != 'pull_request'
#        uses: docker/build-push-action@v5
#        with:
#          context: ./backend
#          push: true
#          tags: ${{ steps.meta.outputs.tags }}
#          labels: ${{ steps.meta.outputs.labels }}

# Get nodePort ja smoke tests lisätty tänne sisälle
# Job 3: Deploy to Kubernetes via SSH
  deploy-to-kubernetes:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Update backend deployment
            kubectl set image deployment/backend-cicd backend=ghcr.io/elitikka/lemp-app2/backend:latest
            
            # Update frontend deployment  
            kubectl set image deployment/frontend-cicd nginx=ghcr.io/elitikka/lemp-app2/frontend:latest
            
            # Restart to pull latest images
            kubectl rollout restart deployment/backend-cicd
            kubectl rollout restart deployment/frontend-cicd
            
            # Wait for rollouts to complete
            kubectl rollout status deployment/backend-cicd --timeout=300s
            kubectl rollout status deployment/frontend-cicd --timeout=300s
            
            # Show status
            echo "=== Deployments ==="
            kubectl get deployments | grep cicd
            echo "=== Pods ==="
            kubectl get pods | grep cicd
            echo "=== Services ==="
            kubectl get services | grep cicd
            
            # Get NodePort
            echo ""
            echo "=== NodePort ==="
            NODE_PORT=$(kubectl get service frontend-cicd -o jsonpath='{.spec.ports[0].nodePort}')
            echo "Frontend NodePort: $NODE_PORT"
            
            # Run smoke tests
            echo ""
            echo "=== Running Smoke Tests ==="
            sleep 10
            
            NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
            FRONTEND_URL="http://$NODE_IP:$NODE_PORT"
            
            echo "Testing: $FRONTEND_URL/cicd/"
            
            # Test that site responds
            if curl -f $FRONTEND_URL/cicd/; then
              echo "✅ Frontend is responding"
            else
              echo "❌ Frontend test failed"
              exit 1
            fi
            
            # Test backend health endpoint
            if curl -f $FRONTEND_URL/cicd/api/health; then
              echo "✅ Backend health check passed"
            else
              echo "❌ Backend health check failed"
              exit 1
            fi
            
            echo ""
            echo "✅ All smoke tests passed!"

#      - name: Deploy via SSH
#        uses: appleboy/ssh-action@v1.0.3
#        with:
#          host: ${{ secrets.SSH_HOST }}
#          username: ${{ secrets.SSH_USER }}
#          key: ${{ secrets.SSH_KEY }}
#          script: |
#            # Update backend deployment
#            kubectl set image deployment/backend-cicd backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${{ github.sha }} --record
#            
#            # Update frontend deployment  
#            kubectl set image deployment/frontend-cicd nginx=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${{ github.sha }} --record
#            
#            # Wait for rollouts to complete
#            kubectl rollout status deployment/backend-cicd --timeout=300s
#            kubectl rollout status deployment/frontend-cicd --timeout=300s
#            
#            # Show status
#            echo "=== Deployments ==="
#            kubectl get deployments | grep cicd
#            echo "=== Pods ==="
#            kubectl get pods | grep cicd
#            echo "=== Services ==="
#            kubectl get services | grep cicd
  
# Lisätty nodeport osa
#      - name: Get NodePort
#        run: |
#          echo "Frontend NodePort:"
#          kubectl get service frontend-cicd -o jsonpath='{.spec.ports[0].nodePort}'
#
#     - name: Run smoke tests
#        run: |
#          # Odota että service on valmis
#          sleep 10
#
#          # Hae frontend-cicd service NodePort <-- Otettu aiemmat turhat jutut pois koska tosiaan käytössä nodeport
#          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
#          NODE_PORT=$(kubectl get service frontend-cicd -o jsonpath='{.spec.ports[0].nodePort}')  # CHANGED
#          FRONTEND_URL="http://$NODE_IP:$NODE_PORT"
#
#          echo "Testing: $FRONTEND_URL/cicd/"
#
#          # Testaa että sivusto vastaa
#          curl -f $FRONTEND_URL/cicd/ || exit 1
#
#          # Testaa backend health endpoint
#          curl -f $FRONTEND_URL/cicd/api/health || exit 1
#
#          echo "✅ Smoke tests passed!"


# Job 4: Rollback on failure
  rollback-on-failure:
    needs: [deploy-to-kubernetes]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Rollback via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "❌ Deployment failed, rolling back..."
            kubectl rollout undo deployment/frontend-cicd
            kubectl rollout undo deployment/backend-cicd
            echo "⏪ Rollback completed"