name: Build and Deploy to Kubernetes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME_FRONTEND: ${{ github.repository }}/frontend
  IMAGE_NAME_BACKEND: ${{ github.repository }}/backend

jobs:
  # Job 1: Build ja testaa frontend
  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker build ja push
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Job 2: Build ja testaa backend
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    services:
      # Test-MySQL kontainer
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test_password
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        working-directory: ./backend
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8

      - name: Run linter
        working-directory: ./backend
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run tests
        working-directory: ./backend
        env:
          DATABASE_URL: mysql://root:test_password@mysql:3306/test_db
          PYTHONPATH: . # Lisätty tämä rivi koska actioneissa tuli joku error eikä se löytänyt jotain modulea tms. 
        run: pytest --cov=. --cov-report=xml

      # Docker build ja push
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: Build and push Docker image
        if: github.event_name != 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Job 3: Deploy to Kubernetes via SSH
  deploy-to-kubernetes:
    needs: [build-frontend, build-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Update backend deployment
            kubectl set image deployment/backend-cicd backend=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${{ github.sha }} --record
            
            # Update frontend deployment  
            kubectl set image deployment/frontend-cicd nginx=${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${{ github.sha }} --record
            
            # Wait for rollouts to complete
            kubectl rollout status deployment/backend-cicd --timeout=300s
            kubectl rollout status deployment/frontend-cicd --timeout=300s
            
            # Show status
            echo "=== Deployments ==="
            kubectl get deployments | grep cicd
            echo "=== Pods ==="
            kubectl get pods | grep cicd
            echo "=== Services ==="
            kubectl get services | grep cicd
  
  # Job 3: Deploy Kubernetesiin
#  deploy-to-kubernetes:
#    needs: [build-frontend, build-backend]
#    runs-on: ubuntu-latest
#    if: github.ref == 'refs/heads/main' && github.event_name == 'push'##
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4#
#
#      - name: Update image tags in Kubernetes manifests
#        run: |
#          # Päivitä frontend image
#          sed -i "s|image: .*frontend.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_FRONTEND }}:main-${{ github.sha }}|" kubernetes/frontend-deployment.yaml#
#
#          # Päivitä backend image
#          sed -i "s|image: .*backend.*|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_BACKEND }}:main-${{ github.sha }}|" kubernetes/backend-deployment.yaml

# MySQL deployment otettu pois, koska käytetään aiemman viikkotehtävän kanssa samaa mysql db:tä, joka on jo pyörimässä. 
#      - name: Deploy MySQL (jos ei ole jo olemassa)
#        run: |
#          kubectl apply -f kubernetes/mysql-deployment.yaml

# Lisätty deploymentti configmapille
#      - name: Deploy backend ConfigMap
#        run: kubectl apply -f kubernetes/backend-configmap.yaml#
#      - name: Deploy backend
#        run: |
#         kubectl apply -f kubernetes/backend-deployment.yaml
#          kubectl rollout status deployment/backend-cicd
#
#      - name: Deploy frontend
#        run: |
#          kubectl apply -f kubernetes/frontend-deployment.yaml
#          kubectl rollout status deployment/frontend-cicd

#Verifyihin lisätty  "| grep cicd" riveille.
#      - name: Verify deployment
#        run: |
#          echo "=== Pods ==="
#          kubectl get pods | grep cicd
#          echo "=== Services ==="
#          kubectl get services | grep cicd
#          echo "=== Deployment status ==="
#          kubectl get deployments | grep cicd

# Lisätty nodeport osa
      - name: Get NodePort
        run: |
          echo "Frontend NodePort:"
          kubectl get service frontend-cicd -o jsonpath='{.spec.ports[0].nodePort}'

      - name: Run smoke tests
        run: |
          # Odota että service on valmis
          sleep 10

          # Hae frontend-cicd service NodePort <-- Otettu aiemmat turhat jutut pois koska tosiaan käytössä nodeport
          NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          NODE_PORT=$(kubectl get service frontend-cicd -o jsonpath='{.spec.ports[0].nodePort}')  # CHANGED
          FRONTEND_URL="http://$NODE_IP:$NODE_PORT"

          echo "Testing: $FRONTEND_URL/cicd/"

          # Testaa että sivusto vastaa
          curl -f $FRONTEND_URL/cicd/ || exit 1

          # Testaa backend health endpoint
          curl -f $FRONTEND_URL/cicd/api/health || exit 1

          echo "✅ Smoke tests passed!"

# Job 4: Rollback on failure
  rollback-on-failure:
    needs: [deploy-to-kubernetes]
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: Rollback via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            echo "❌ Deployment failed, rolling back..."
            kubectl rollout undo deployment/frontend-cicd
            kubectl rollout undo deployment/backend-cicd
            echo "⏪ Rollback completed"

  # Job 4: Rollback jos deployment epäonnistuu
#  rollback-on-failure:
#    needs: [deploy-to-kubernetes]
#    runs-on: ubuntu-latest
#    if: failure()
#
#    steps:
#      - name: Setup kubectl
#        uses: azure/setup-kubectl@v3
#
#      - name: Configure kubectl
#        run: |
#          mkdir -p $HOME/.kube
#          echo "${{ secrets.KUBE_CONFIG }}" | base64 -d > $HOME/.kube/config
#
#      - name: Rollback deployments
#        run: |
#          echo "❌ Deployment failed, rolling back..."
#          kubectl rollout undo deployment/frontend-cicd
#          kubectl rollout undo deployment/backend-cicd
#          echo "⏪ Rollback completed"